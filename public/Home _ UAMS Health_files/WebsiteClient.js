var __awaiter=this&&this.__awaiter||function(o,s,a,l){return new(a||(a=Promise))(function(e,t){function i(e){try{r(l.next(e))}catch(e){t(e)}}function n(e){try{r(l.throw(e))}catch(e){t(e)}}function r(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(i,n)}r((l=l.apply(o,s||[])).next())})},__generator=this&&this.__generator||function(i,n){var r,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=o[2&t[0]?"return":t[0]?"throw":"next"])&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[0,s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(i,a)}catch(e){t=[6,e],o=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();define("jquery-private",["require","exports","jquery"],function(e,t,i){"use strict";return i.noConflict(!0)}),define("WebsiteClient/CookieManager",["require","exports","WebsiteClient/config","js-cookie"],function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this._neverCookieName="gsight2_NeverCookie",this._yesCookieName="gsight2_YesCookie"}return e.prototype.hasNeverCookie=function(){return this.hasCookie(this._neverCookieName)},e.prototype.setNeverCookie=function(){n.set(this._neverCookieName,"true",{expires:i.invite.daysToWait.never})},e.prototype.hasYesCookie=function(){return this.hasCookie(this._yesCookieName)},e.prototype.setYesCookie=function(){n.set(this._yesCookieName,"true",{expires:i.invite.daysToWait.yes})},e.prototype.hasCookie=function(e){return!!n.get(e)},e}();t.CookieManager=r}),define("WebsiteClient/IpReader",["require","exports","jquery"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.getExternalIp=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,i.ajax({url:"https://api.ipify.org",type:"GET",data:{format:"jsonp"},dataType:"jsonp"})];case 1:return[2,e.sent().ip]}})})},e}();t.IpReader=n}),define("WebsiteClient/IpChecker",["require","exports","WebsiteClient/config","WebsiteClient/IpReader","ipaddr"],function(e,t,s,i,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._ipReader=new i.IpReader}return e.prototype.isCurrentIpFiltered=function(){return __awaiter(this,void 0,void 0,function(){var t,i,n,r,o;return __generator(this,function(e){switch(e.label){case 0:return[4,this._ipReader.getExternalIp()];case 1:for(t=e.sent(),i=a.parse(t),n=0;n<s.invite.ipFilters.length;n++)if(r=s.invite.ipFilters[n],console.log(r),o=a.parseCIDR(r),i.match(o))return[2,!0];return[2,!1]}})})},e}();t.IpChecker=n}),define("WebsiteClient/PopupDisplayCalculator",["require","exports","WebsiteClient/config","WebsiteClient/CookieManager","WebsiteClient/IpChecker"],function(e,t,i,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){this._cookieManager=new n.CookieManager,this._ipChecker=new r.IpChecker}return e.prototype.willUserSeePopup=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this._ipChecker.isCurrentIpFiltered()];case 1:return e.sent()?(console.log("Current ip is filtered, will not display."),[2,!1]):this._cookieManager.hasNeverCookie()?(console.log("Has never cookie, will not display."),[2,!1]):this._cookieManager.hasYesCookie()?(console.log("Has yes cookie, will not display."),[2,!1]):this.passesSamplingPercent()?[2,!0]:[2,!1]}})})},e.prototype.passesSamplingPercent=function(){var e=1e3*i.invite.samplingPercentage,t=Math.floor(1e5*Math.random())+1;return console.log("Sampling check: "+t),t<=e},e}();t.PopupDisplayCalculator=o}),define("WebsiteClient/TemplateReader",["require","exports","jquery","WebsiteClient/config"],function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.readTemplate=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,i.ajax({url:n.baseUrl+"/templates/"+t+".html",method:"GET",type:"html"})];case 1:return[2,e.sent()]}})})},e}();t.TemplateReader=r}),define("WebsiteClient/ApiResults/ApiResult",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.success=!1,this.message=""};t.ApiResult=i}),define("WebsiteClient/ApiResults/RecordInviteApiResult",["require","exports","WebsiteClient/ApiResults/ApiResult"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(i.ApiResult);t.RecordInviteApiResult=n}),define("WebsiteClient/InviteResponseSaver",["require","exports","WebsiteClient/config","jquery"],function(e,t,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._url=i.gsightApiUrl+"/api/Invites/RecordResponse"}return e.prototype.recordNow=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.recordResponse("now",t)];case 1:return[2,e.sent()]}})})},e.prototype.recordNever=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.recordResponse("never",t)];case 1:return[2,e.sent()]}})})},e.prototype.recordLater=function(t,i,n,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.recordResponse("later",t,i,r,n)];case 1:return[2,e.sent()]}})})},e.prototype.recordResponse=function(t,i,n,r,o){return void 0===n&&(n=""),void 0===r&&(r=""),void 0===o&&(o=""),__awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,s.ajax({url:this._url,data:{inviteId:i,response:t,email:n,carrier:r,phone:o},dataType:"jsonp",type:"GET"})];case 1:return[2,e.sent()]}})})},e}();t.InviteResponseSaver=n}),define("WebsiteClient/BaseUrlBuilder",["require","exports","WebsiteClient/config"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.getBaseUrl=function(){return this.getUrl(i.baseUrl)},e.prototype.getUrl=function(e){var t=document.location.protocol;return":"!=t.charAt(t.length-1)&&(t+=":"),"/"==e.charAt(0)?t+"//"+document.domain+e:e},e}();t.BaseUrlBuilder=n}),define("WebsiteClient/SurveyPopup",["require","exports","WebsiteClient/config","ejs","WebsiteClient/TemplateReader","WebsiteClient/BaseUrlBuilder"],function(e,t,a,l,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this._templateReader=new i.TemplateReader,this._baseUrlBuilder=new n.BaseUrlBuilder,this._inviteId=e}return e.prototype.runPopup=function(e){var t=e.document.createElement("script"),i=this._baseUrlBuilder.getBaseUrl();t.src=i+"/survey.js",t.async=!0,t.type="text/javascript",e.document.head.appendChild(t);var n=document.domain;e.document.getElementsByTagName("body")[0];e.document.getElementById("inviteId").value=this._inviteId,e.document.getElementById("originalDomain").value=n,e.document.getElementById("apiUrl").value=a.gsightApiUrl;var r=e.document.getElementById("popupTemplate"),o=e.document.getElementById("popupContainer"),s=l.compile(r.innerHTML)(a);o.innerHTML=s,e.document.getElementById("logo").src=this._baseUrlBuilder.getUrl(a.logoUrl)},e.prototype.showPopup=function(i){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this._templateReader.readTemplate("survey-waiting")];case 1:return t=e.sent(),i.document.documentElement.innerHTML=t,this.runPopup(i),[2]}})})},e}();t.SurveyPopup=r}),define("WebsiteClient/PhoneCleaner",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.prototype.cleanPhone=function(e){var t=e;return 11==(t=t.replace(/[^0-9]/g,"")).length&&"1"==t.substr(0,1)&&(t=t.substr(1)),t},e}();t.PhoneCleaner=i}),define("WebsiteClient/GSightDialog",["require","exports","jquery"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.screenCover=null}return e.prototype.showDialog=function(e){var t=this;this.showScreenCover(),e.show(),e.find(".gsight2_inviteDialog_headerCloseButton").click(function(){return t.closeClicked(e),!1})},e.prototype.hideDialog=function(e){this.hideScreenCover(),e.hide()},e.prototype.closeClicked=function(e){this.hideDialog(e)},e.prototype.showScreenCover=function(){this.getScreenCover().show()},e.prototype.hideScreenCover=function(){this.getScreenCover().hide()},e.prototype.getScreenCover=function(){return null==this.screenCover&&(this.screenCover=i("<div />"),this.screenCover.addClass("gsight2_inviteDialog_screenCover"),i("body").append(this.screenCover)),this.screenCover},e}();t.GSightDialog=n}),define("WebsiteClient/LaterDialog",["require","exports","jquery","WebsiteClient/TemplateReader","WebsiteClient/config","ejs","WebsiteClient/CookieManager","WebsiteClient/InviteResponseSaver","WebsiteClient/PhoneCleaner","WebsiteClient/GSightDialog"],function(e,t,i,n,o,s,r,a,l,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e){this._gsightDialog=new u.GSightDialog,this._templateReader=new n.TemplateReader,this._cookieManager=new r.CookieManager,this._inviteInfo=e,this._inviteResponseSaver=new a.InviteResponseSaver,this._phoneCleaner=new l.PhoneCleaner}return e.prototype.show=function(){return __awaiter(this,void 0,void 0,function(){var t,i,n,r;return __generator(this,function(e){switch(e.label){case 0:return[4,this._templateReader.readTemplate(o.later.template)];case 1:return t=e.sent(),i=s.compile(t),n=i(o),r=this.getDialogContainer(n).find(".gsight2_inviteDialog"),this._gsightDialog.showDialog(r),this.dialogBuilt(r),[2]}})})},e.prototype.dialogBuilt=function(e){console.log("In dialog built"),this._container=e,this._uxPhone=i("#gsight2_phone"),this._uxCarrier=i("#gsight2_carrier"),this._uxEmail=i("#gsight2_email"),this._uxEmailButton=i("#gsight2_sendTypeEmail"),this._uxTextButton=i("#gsight2_sendTypeText"),this.initRadioButtons(),this.initPhoneField(),this.initCancelButton(),this.initSendButton()},e.prototype.initPhoneField=function(){var e=this;this._uxPhone.blur(function(){e._uxPhone.val(e._phoneCleaner.cleanPhone(e._uxPhone.val()))})},e.prototype.initRadioButtons=function(){var e=i("#gsight2_emailForm"),t=i("#gsight2_textForm");this._uxEmailButton.click(function(){e.removeClass("gsight2_inviteDialog_hidden"),t.addClass("gsight2_inviteDialog_hidden")}),this._uxTextButton.click(function(){t.removeClass("gsight2_inviteDialog_hidden"),e.addClass("gsight2_inviteDialog_hidden")})},e.prototype.initCancelButton=function(){var e=this;i("#gsight2_laterDialog_cancel").click(function(){return e._gsightDialog.hideDialog(e._container),!1})},e.prototype.initSendButton=function(){var t=this;i("#gsight2_laterDialog_send").click(function(){return t.isValid()&&(t._inviteResponseSaver.recordLater(t._inviteInfo.inviteId,t._uxEmail.val(),t._uxPhone.val(),t._uxCarrier.val()).then(function(e){e.success?(t._cookieManager.setYesCookie(),console.log("Later response recorded")):console.error(e.message)}),t._gsightDialog.hideDialog(t._container)),!1})},e.prototype.isValid=function(){if(this._uxEmailButton.prop("checked")){if(""==i.trim(this._uxEmail.val()))return alert("Please enter a valid email"),!1}else if(this._uxTextButton.prop("checked")){if(""==i.trim(this._uxCarrier.val()))return alert("Please select a carrier"),!1;if(""==i.trim(this._uxPhone.val()))return alert("Please enter a valid phone number"),!1;if(i.trim(this._uxPhone.val()).length<10)return alert("Please enter a full phone number with the area code"),!1}return!0},e.prototype.getDialogContainer=function(e){var t=i("[data-gsight2-dialog-container=gsight2LaterDialog]");return 0<t.length&&t.remove(),(t=i("<div />")).attr("data-gsight2-dialog-container","gsight2LaterDialog"),t.html(e),i("body").append(t),t},e}();t.LaterDialog=c}),define("WebsiteClient/InviteDialog",["require","exports","jquery","WebsiteClient/TemplateReader","WebsiteClient/config","ejs","WebsiteClient/CookieManager","WebsiteClient/InviteResponseSaver","WebsiteClient/SurveyPopup","WebsiteClient/LaterDialog","WebsiteClient/GSightDialog"],function(e,t,r,i,s,o,n,a,l,u,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=function(){function e(e){var o=this;this._gsightDialog=new c.GSightDialog,this.onNowClicked=function(){o._cookieManager.setYesCookie(),console.log('Recording "now"'),o._inviteResponseSaver.recordNow(o._inviteInfo.inviteId).then(function(e){e.success?console.log('"now" recorded'):console.error(e.message)});var e=s.survey.width,t=s.survey.height;e>screen.width&&(e=screen.width),t>screen.height&&(t=screen.height);var i=screen.width/2-e/2,n="location=no,resizable=yes,scrollbars=yes,width="+e+",height="+t+",top = "+(screen.height/2-t/2)+",left = "+i,r=window.open("","gSightSurveyPopupWindow",n);return new l.SurveyPopup(o._inviteInfo.inviteId).showPopup(r),o._gsightDialog.hideDialog(o._container),!1},this.onLaterClicked=function(){return new u.LaterDialog(o._inviteInfo).show(),o._gsightDialog.hideDialog(o._container),!1},this.onNeverClicked=function(){return o._cookieManager.setNeverCookie(),o._gsightDialog.hideDialog(o._container),!1},this._templateReader=new i.TemplateReader,this._cookieManager=new n.CookieManager,this._inviteInfo=e,this._inviteResponseSaver=new a.InviteResponseSaver}return e.prototype.show=function(){return __awaiter(this,void 0,void 0,function(){var t,i,n,r;return __generator(this,function(e){switch(e.label){case 0:return[4,this._templateReader.readTemplate(s.invite.template)];case 1:return t=e.sent(),i=o.compile(t),n=i(s),r=this.getDialogContainer(n).find(".gsight2_inviteDialog"),this._gsightDialog.showDialog(r),this.setupEvents(r),[2]}})})},e.prototype.setupEvents=function(e){console.log("Configuring dialog events..."),this._container=e;var t=r("#gsight2_inviteDialog_yesNowButton"),i=r("#gsight2_inviteDialog_neverButton"),n=r("#gsight2_inviteDialog_yesLaterButton");i.click(this.onNeverClicked),t.click(this.onNowClicked),n.click(this.onLaterClicked)},e.prototype.getDialogContainer=function(e){var t=r("[data-gsight2-dialog-container=gsight2Invite]");return 0<t.length&&t.remove(),(t=r("<div />")).attr("data-gsight2-dialog-container","gsight2Invite"),t.html(e),r("body").append(t),t},e}();t.InviteDialog=p}),define("WebsiteClient/InviteRecorder",["require","exports","WebsiteClient/config","jquery","ua-parser-js"],function(e,t,n,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._recordInviteUrl=n.gsightApiUrl+"/api/Invites/RecordInvite"}return e.prototype.recordInvite=function(){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){switch(e.label){case 0:return t=new o,i=t.getResult(),[4,r.ajax({url:this._recordInviteUrl,data:{clientKey:n.clientId,userAgent:i.ua,browserName:i.browser.name,browserVersion:i.browser.version,currentUrl:window.location.href,deviceName:i.device.type},dataType:"jsonp",type:"GET"})];case 1:return[2,e.sent()]}})})},e}();t.InviteRecorder=i}),define("WebsiteClient",["require","exports","jquery","WebsiteClient/config","WebsiteClient/PopupDisplayCalculator","WebsiteClient/InviteDialog","WebsiteClient/InviteRecorder","promise-polyfill"],function(e,t,n,r,i,o,s){"use strict";return function(){function e(){this._popupDisplayCalc=new i.PopupDisplayCalculator,this._inviteRecorder=new s.InviteRecorder}return e.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),(null==r.autoLoadCss||r.autoLoadCss)&&(this.loadCss(r.baseUrl+"/css/client-styles.css"),this.loadCss(r.baseUrl+"/css/invite.css")),[4,this._popupDisplayCalc.willUserSeePopup()];case 1:return e.sent()?(console.log("Invite popup will show in "+r.invite.popupDelayInSeconds+" seconds"),[4,this.delay(r.invite.popupDelayInSeconds)]):[2];case 2:return e.sent(),console.log("Recording invite"),[4,this._inviteRecorder.recordInvite()];case 3:return t=e.sent(),console.log("Showing invite popup"),t.success?new o.InviteDialog(t).show():console.log(t.message),[3,5];case 4:return i=e.sent(),console.error(i),[3,5];case 5:return[2]}})})},e.prototype.loadCss=function(e){var t=n("<link />");t.attr({type:"text/css",rel:"stylesheet",href:e});var i=n("head").find("link").first();i&&1==i.length?t.insertBefore(i):n("head").prepend(t)},e.prototype.delay=function(t){return new Promise(function(e){setTimeout(e,1e3*t)})},e}()});